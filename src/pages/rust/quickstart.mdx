import { Steps, Tabs, Tab, Callout } from "nextra-theme-docs";
import GettingStartedSnippet from "@/snippets/quickstart-getting-started-intro.mdx"
import PreviewMetricsInExplorerSnippet from "@/snippets/preview-in-am-explorer.mdx"


<GettingStartedSnippet lang="Rust"/>

<Steps>
### Add Autometrics

```bash copy
cargo add autometrics
```

### Add the Autometrics macro

Add the `#[autometrics]` to the functions you want to instrument with metrics

```rust
use autometrics::autometrics;

#[autometrics]
pub async fn create_user() {
	// ...
}
```

### Export the metrics

<Tabs items={['Expose a endpoint for Prometheus', 'Push to a OpenTelemetry collector']}>
    <Tab>
        <Callout type="info">
            If you're already using Prometheus metrics in your app, you can skip this step. You only need to configure Autometrics to use the same underlying metrics collection library as your existing Prometheus metrics. See [Metrics Libraries](https://docs.rs/autometrics/latest/autometrics/#metrics-libraries) for more information in the API reference.
        </Callout>

        Autometrics includes optional functions to help collect and prepare metrics to be scraped by Prometheus.
        In order to use those, add the `prometheus-exporter` feature to your `autometrics` dependency in your `Cargo.toml` like this:

        ```toml
        autometrics = { version = "*", features = ["prometheus-exporter"] }
        ```

        Then, in your main function, initialize the `prometheus_exporter`:

        ```rust
        use autometrics::prometheus_exporter;

        pub fn main() {
            prometheus_exporter::init();
            // ...
        }
        ```

        And create a route on your API (probably mounted under `/metrics`) that returns the following:

        ```rust
        use autometrics::prometheus_exporter::{self, PrometheusResponse};

        /// Export metrics for Prometheus to scrape
        pub fn get_metrics() -> PrometheusResponse {
            prometheus_exporter::encode_http_response()
        }
        ```
    </Tab>
    <Tab>
        Autometrics includes optional functions to help collect and prepare metrics to be exported to a OpenTelemtry collector.
        In order to use those, you will need to add two features depending on what transport you wish to choose and which
        async runtime your program is using.

        Choose a **transport**:

        * `otel-push-exporter-http`: HTTP using `hyper`
        * `otel-push-exporter-grpc`: gRPC using `tonic`

        Choose a **Runtime**:

        * `otel-push-exporter-tokio`: `tokio`
        * `otel-push-exporter-tokio-current-thread`: `tokio` with `flavor = "current_thread"`
        * `otel-push-exporter-async-std`: `async-std`

        Simply pick the corresponding feature flags for your setup from each list and add it to the `autometrics` dependency
        in your `Cargo.toml`, for example:

        ```toml
        autometrics = { version = "*", features = ["otel-push-exporter-http", "otel-push-exporter-tokio"] }
        ```

        Then, in your main function, initialize the `otel_push_exporter` with the method you used depending on your transport:

        ```rust
        use autometrics::otel_push_exporter;

        pub fn main() {
            otel_push_exporter::init_http("url");
            // or
            otel_push_exporter::init_grpc("url");
        }
        ```
    </Tab>
</Tabs>

You're set! You can now start your app and preview the metrics.

</Steps>

## Viewing your metrics

### Using Autometrics Explorer
<PreviewMetricsInExplorerSnippet/>

### View your metrics in your IDE or dashboard

You can now navigate your code in your IDE, hover over the instrumented functions and you will see links for generated queries for your metrics.

If you have Grafana you can also import the [Autometrics dashboard](https://github.com/autometrics-dev/autometrics-shared#dashboards) for an overview and detailed view of the function metrics.

### Configure Prometheus to scrape your metrics

Make sure your Prometheus can correctly find the metrics generated by Autometrics. See the [Configuring Prometheus](/deploying-prometheus) section for deploy target-specific instructions. 

Example configuration:

```yaml
scrape_configs:
  - job_name: my-app
    metrics_path: /metrics
    static_configs:
      # Replace the port with the port your app listens on
      - targets: ['localhost:3000']
    # For a real deployment, you would want the scrape interval to be
    # longer but for testing, you want the data to show up quickly
    scrape_interval: 200ms
```
