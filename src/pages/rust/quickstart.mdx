import { Steps, Tabs, Tab, Callout } from "nextra-theme-docs";
import GettingStartedSnippet from "@/snippets/quickstart-getting-started-intro.mdx"
import PreviewMetricsInExplorerSnippet from "@/snippets/preview-in-am-explorer.mdx"


<GettingStartedSnippet lang="Rust"/>

<Steps>
### Add Autometrics

```bash copy
cargo add autometrics --features=prometheus-exporter
```

### Add the Autometrics macro

Add the `#[autometrics]` to the functions you want to instrument with metrics

```rust
use autometrics::autometrics;

#[autometrics]
pub async fn create_user() {
	// ...
}
```

### Export the metrics for Prometheus

<Callout type="info">
If you're already using Prometheus metrics in your app, you can skip this step. You only need to configure Autometrics to use the same underlying metrics collection library as your existing Prometheus metrics. See [Metrics Libraries](https://docs.rs/autometrics/latest/autometrics/#metrics-libraries) for more information in the API reference.
</Callout>

Autometrics includes optional functions to help collect and prepare metrics to be scraped by Prometheus.

In your main function, initialize the `global_metrics_exporter`:

```rust
pub fn main() {
  let _exporter = autometrics::global_metrics_exporter();
  // ...
}
```
And create a route on your API (probably mounted under `/metrics`) that returns the following:

```rust
use http::StatusCode;

/// Export metrics for Prometheus to scrape
pub fn get_metrics() -> (StatusCode, String) {
  match autometrics::encode_global_metrics() {
    Ok(metrics) => (StatusCode::OK, metrics),
    Err(err) => (StatusCode::INTERNAL_SERVER_ERROR, format!("{:?}", err))
  }
}
```

You're set! You can now start your app and preview the metrics.

</Steps>

## Viewing your metrics

### Using Autometrics Explorer
<PreviewMetricsInExplorerSnippet/>

### View your metrics in your IDE or dashboard

You can now navigate your code in your IDE, hover over the instrumented functions and you will see links for generated queries for your metrics.

If you have Grafana you can also import the [Autometrics dashboard](https://github.com/autometrics-dev/autometrics-shared#dashboards) for an overview and detailed view of the function metrics.

### Configure Prometheus to scrape your metrics

Make sure your Prometheus can correctly find the metrics generated by Autometrics. See the [Configuring Prometheus](/configuring-prometheus) section for deploy target-specific instructions. 

Example configuration:

```yaml
scrape_configs:
  - job_name: my-app
    metrics_path: /metrics
    static_configs:
      # Replace the port with the port your app listens on
      - targets: ['localhost:3000']
    # For a real deployment, you would want the scrape interval to be
    # longer but for testing, you want the data to show up quickly
    scrape_interval: 200ms
```
